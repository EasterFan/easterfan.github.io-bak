---
title: Jasmine 的 TDD 初实践
tags: JavaScript TDD Tasking任务分解
---

## START
在实现一个功能后, 我们通常会用单元测试来检验这个功能是否能实现, 很希望能看到功能通过, 如果报错或是给出错误输出, 继续回来 debug 修复,直到功能通过.  
<!--more-->

### 一个问题
有一种情况是, 为了修复一个错误输出, 尝试引入三五个变量, 好不容易得到正确的输出, 突然发现整个逻辑不对了, 引入变量后, 又多了几个情况要考虑, 引发了一场 bug 连环惨案, 从此在 dubug 的路上越走越远.  

先写功能后测试的一个问题在于, 写功能的过程中可能遇到一些多解的问题, 比如简单一点的有交换两个变量的值, 可以不假思索的引入一个临时变量来完成, 不想引入变量, 可以两数相加再相减, 或是用异或的特性来实现, 但如果稍微复杂一点, 用一个集合对象存储库存中出库入库记录, 是用 List , 还是用 Set , Map 或其它? 这个对象是查找操作多一些, 还是增删操作多一些? 一开始集合的选择有很多种, 看似都可以实现存储记录的功能, 可以先用最常用的 ArrayList 存一下, 可是写到后面发现功能中有一个不能存储相同记录的功能没有实现, ArrayList 的特性使然,于是返工去更换 ArrayList, 甚至也许还会一不小心顺带改了点其它什么, 顺手造一些新的 bug.......  

### 一个解决方法
有经验的程序员在动手之前通常会在纸上画一些东西, 捋一捋思路,确定每一步的输入输出, 然后再顺着这个已经成型的思路, 去实现每一个方法, 再耐心一点的程序员, 甚至还会每写完一个方法, 都要 `sout(result)` 一下, 来比对实际输出和期望值的差异, 这样一遍手动测试一遍写功能的方法, 显然很大程度上能保证每一步的输入输出都是在预期范围内上下浮动的, 很稳, 但又写测试又写功能, 增加了很多代码量, 而且功能实现后, 这些测试的过程代码都要删去, 不能保存和复用, 很多情况下, 比起先写功能后测试, 这在完成相同功能的情况下, 要花费更多的时间.  

TDD 尝试解决这个问题.  
## WHAT'S TDD ?
> 一个方法论, 要求在编写某个功能代码之前先编写测试代码, 然后只编写使测试通过的功能代码, **通过测试来推动整个开发的进行(Test-Driven Development)**

### 1. 来源
TDD 来源于极限编程, 主要应用于个人开发者  
![](/assets/img/blog/2018/2018-05-02-tddorigin.png)  

狭义上的TDD 是 UTDD (单元测试驱动开发 -- 也是最常见),   
扩展后的广义 TDD 有 ATDD(验收测试驱动开发) BDD(行为驱动开发)

### 2. 含义
TDD 有三重含义:  
- Test First Development -- 代码未动,测试先行  
- Task-Driven Devlopment -- 开发 + 测试
- Test-Driven Design --  重构  

## HOW TO TDD

![](/assets/img/blog/2018/2018-05-02-howtotdd.jpeg)  

以[黄焖鸡](https://github.com/tws-online-quiz/take-out-food)为例:  

### 1. 理解题意
商店里有两种优惠方式, 要求根据消费者购买的商品, 自动选择对消费者最优惠的方案, 并给出所有商品的清单, 整个程序的输入输出是:  

![](/assets/img/blog/2018/2018-05-02-hmjtdd.png)  

### 2. 任务分解
> 一个在头脑中构思整个步骤的完整过程, 并确定每一步的输入输出

#### 1. Tasking
> 任务分解三步走 ===> 分解计划 -->  画图 ---> 计时实现  

从 `5W1H`上去思考程序的输入输出  
![](/assets/img/blog/2018/2018-05-02-tasking1.png)  

想的很多,但不必都画在纸上,只需要重点考虑输入从哪里来 + 输入的数据类型  
考虑输出到哪去 + 输出的数据类型  
![](/assets/img/blog/2018/2018-05-02-tasking2.png)  

计划完了, 开始写, 预计每一个步骤大概要多长时间完成, 如果不能按时完成, 找一找原因- 按照`PDCA` 去执行  
![](/assets/img/blog/2018/2018-05-02-tasking3.png)  

#### 2. 黄焖鸡的Tasking

做任务分解, 确定每一步的输入输出, Tasking 图:  
这里我先把整个程序分解成 4 步:  

1. 格式化用户输入(format_userInput)
  - 输入: 商品条形码 - []
  - 输出: 商品条形码 - [Object]

2. 补全用户输入(compelete_userinput)
  - 输入: 商品条形码 - [Object] + allitems 所有商品信息 -  [Object] 
  - 输出: 商品完整信息 - [object]

3. 添加节省的金额(addPromotionSave)
  - 输入: 商品完整信息 - [object] + promotions 两种优惠方式 - [Object]
  - 输出: 添加节省金额的完整信息 - object

4. 打印输出(printBestCharge)
  - 输入: 添加节省金额的完整信息 - object
  - 输出: 打印 - String

![](/assets/img/blog/2018/2018-05-02-Tasking.png)  
### 3. 开始 TDD
怎样使用 jasmine 对一个方法进行测试?  

首先了解一个测试文件的结构, 一般一个文件的测试是由三个部分组成的(Given  When  Then ):  

![](/assets/img/blog/2018/2018-05-02-jasmine.jpg)  

1. 最外层的 describe 是 Given, 表示当前要被测试的文件  
2. 中间层的 describe 是 when, 表示测试是在什么条件下进行的  
3. 最内层的 it 是一个断言, 表示在测试文件在特定条件下, 程序运行的结果 === 我们期望得到的结果  

`describe`和 `it` 中传入了两个参数, 第一个参数是对测试的描述, 可以随便起名字,  
第二个参数是传入的方法, 表示要测试的对象是一个方法, 我在任务分解时将整个实现分为了四步, 所以我需要写四个 tdd , 逐个测试这四个函数的输出.  

![](/assets/img/blog/2018/2018-05-02-4TDD.png)  

当四个测试运行后都通过时, 突然发现测试通过, 是基于消费者输入`["ITEM0001 x 1", "ITEM0013 x 2", "ITEM0022 x 1"]`这一条件(含有指定商品半价),  
如果消费者输入的是满30减6条件呢?  
或者两种优惠都包含?   
或者两种优惠都不包含? 测试结果会怎样?  

这个时候, 就需要再补两个测试用例了,将这两种情况包含进去:  

![](/assets/img/blog/2018/2018-05-02-2addttdd.png)  

到此, 这个程序就算完成了, 可运行可测试, 这就结束了吗?   
你还可以再重构一下.  

卒.









